<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=320">
        <link rel="stylesheet" media="screen, print" href="../../styles/reset-min.css">
        <link rel="stylesheet" media="screen, print" href="../../styles/fonts-min.css">
        <link rel="stylesheet" media="screen and (min-device-width: 481px), print" href="../../styles/cg.css">
        <link rel="stylesheet" media="only screen and (max-device-width: 480px)" href="../../styles/iphone.css">
        <!--[if IE]><link rel="stylesheet" media="screen, projection" href="../../styles/cg.css"><![endif]-->
        <!--[if lte IE 8]><script src="../../scripts/create-elements.js" type="text/javascript"></script><![endif]-->
        <script src="../../scripts/highlight.pack.js" type="text/javascript"></script>
        <link rel="stylesheet" media="screen, print" href="../../styles/github.css">
        <script type="text/javascript">hljs.initHighlightingOnLoad('bash','python','html','css');</script>
        <title>Google App Engine / Python - yono.github.com</title>
    </head>
    <body>
        <header>
          <h1><a href="http://yono.github.com">yono.github.com</a></h1>
        </header>

        <nav>
            <ul>
                <li><a href="index.html">Index</a></li>
            </ul>
        </nav>

        <article>

<!-- Auto generated start -->

<h1>Google App Engine / Python</h1>

<h2>Google App Engine とは</h2>

<ul>
<li>Google が提供するサービスの一つ</li>
<li>Web アプリケーションを Google のインフラ上で実行する環境を提供する</li>
<li>PaaS (Platform as a Service) に分類される

<ul>
<li>Web アプリケーションが実際に動作するマシンを意識しなくともよい</li>
<li>本番環境があらかじめ整備されている</li>
<li>開発言語が制限される

<ul>
<li>Python (GAE/P)</li>
<li>Java (GAE/J)</li>
<li>JVM 上で動けば（Scala, JRuby, Quercus など) 一応 OK</li>
</ul>
</li>
<li>一般的な RDBMS は使えない

<ul>
<li>DataStore というデータを保存する仕組みが用意されている</li>
</ul>
</li>
</ul>
</li>
</ul>


<h3>基本的に無料</h3>

<p>その代わりいろいろと制限があります。</p>

<ul>
<li>作成できるアプリケーションは10個まで

<ul>
<li>一旦作成したドメイン名は変更できません</li>
</ul>
</li>
<li>DataStore の容量: 1GB</li>
<li>一日あたり

<ul>
<li>CPU時間: 6.5 CPU-hours</li>
<li>ネットワーク帯域: 1 GB(受信発信それぞれ)</li>
<li>送信できる E-mail の数: 2000</li>
</ul>
</li>
<li>1 リクエストは 30 秒以内に終えること</li>
</ul>


<p>課金することで緩めることのできる制限もあります</p>

<h3>制限を超過すると</h3>

<p>503 Error を返すようになります。一日ごとにこの制限はリセットされます。</p>

<h2>GAE/P で開発するための準備</h2>

<p>GAE/P で開発するための準備として、主に</p>

<ul>
<li>SDK をインストールする</li>
<li>GAE に登録する</li>
</ul>


<p>の二つが必要です。</p>

<h3>Python をインストールする</h3>

<p>SDK をインストールする前に、まずは Python をインストールする必要があります。</p>

<p>GAE/P は Python 2.5 以上の 2.x 環境が必要です。</p>

<p>バージョンを確認する場合は以下のコマンドを実行してください。</p>

<pre><code>% python -V
</code></pre>

<p>最近の OS（OS X Snow Leopard や Ubuntu 10.4 など）では 2.6 がインストールされてますのでそのままで結構です。
また、3.x 系列だと（デフォルトでインストールされていることはまずないでしょうが）動かないので注意が必要です。</p>

<p>Python のダウンロードは<a href="http://www.python.org/download/">http://www.python.org/download/</a> からできます。</p>

<p>参考URL: <a href="http://yono.github.com/python/python_basics/introduction.html">Python イントロダクション</a></p>

<h3>SDK をダウンロードする</h3>

<p><a href="http://code.google.com/intl/ja/appengine/downloads.html">http://code.google.com/intl/ja/appengine/downloads.html</a> から
OS ごとにダウンロードできます。</p>

<p>Windows or Mac OS X には GoogleAppEngineLauncher というアプリケーションが付属しますが Linux の場合はライブラリ一式が渡されるので自分で適当なディレクトリに配置して使用します。</p>

<p>以降、Linux でのインストール方法を解説します。</p>

<h3>SDK の配置</h3>

<pre><code>% wget http://googleappengine.googlecode.com/files/google_appengine_1.3.4.zip
% unzip google_appengine_1.3.4.zip
% ls
google_appengine/  google_appengine_1.3.4.zip
</code></pre>

<p>解凍してできた google_appengine を適当なディレクトリに置きます。今回は /usr/local に配置することにします。</p>

<pre><code># mv google_appengine /usr/local
</code></pre>

<p>配置したディレクトリを PATH と PYTHONPATH に設定します。</p>

<pre><code># zsh の場合
PATH=$PATH:/usr/local/google_appengine
export PYTHONPATH=$PYTHONPATH:/usr/local/google_appengine
</code></pre>

<p>SDK が適切にインストールされたか確認するために、デモアプリケーションを動かしてみましょう</p>

<pre><code>% dev_appserver.py /usr/local/google_appengine/demos/guestbook
</code></pre>

<p>正常に起動すれば ok です。<a href="http://localhost:8080">http://localhost:8080</a>にアクセスしてみましょう。
<a href="../../images/guestbook.jpg"><img src="../../images/guestbook.jpg" alt="guestbook"/ height="70%" width="70%"></a></p>

<p><em>正常に起動しない場合</em></p>

<p>下記のようなエラーが出た場合、アクセス権を修正する必要があります。</p>

<pre><code>appengine/tools/dev_appserver_main.py", line 66, in 
from google.appengine.tools import os_compat
ImportError: cannot import name os_compat
</code></pre>

<p>以下のコマンドを実行してみてください。</p>

<pre><code>% cd /usr/local/google_appengine
% sudo chmod -R ugoa+r * 
</code></pre>

<p>管理者権限を持っていないユーザの場合上記のエラーが出ることがあるようです。</p>

<p>参考URL:</p>

<ul>
<li><a href="http://www.dr-chuck.com/csev-blog/2010/03/app-engine-fix-for-importerror-cannot-import-name-os_compat/">http://www.dr-chuck.com/csev-blog/2010/03/app-engine-fix-for-importerror-cannot-import-name-os_compat/</a></li>
<li><a href="http://fileformat.wordpress.com/2010/03/14/fix-for-google-appengine-importerror-cannot-import-name-os_compat-on-linux/">http://fileformat.wordpress.com/2010/03/14/fix-for-google-appengine-importerror-cannot-import-name-os_compat-on-linux/</a></li>
</ul>


<h3>GAE へのアカウント登録</h3>

<p>作成したアプリケーションをデプロイするためには、アカウントを登録する必要があります（Google アカウントを持っている前提）。
アカウント登録には携帯電話が必要です。</p>

<p><a href="http://appengine.google.com">http://appengine.google.com</a> にアクセスし、[Welcome to Google App Engine] → [Create an Application] の順に進みます。</p>

<p>Verify Your Acount by SMS という画面に進むので、</p>

<p>Country and Carrier: でそれぞれ Japan, 携帯電話のキャリアを選択します。</p>

<p>Username: に携帯電話の e-mail アドレスの @ より前の部分を入力します。</p>

<p>[Send] を押すと、携帯に下記のような 7 桁の認証キーが送られてきます。</p>

<p>Google App Engine Code: 0000000</p>

<p>これを画面に入力すると、アカウントの登録が完了します。</p>

<p><em>注意</em>: 携帯の e-mail 設定で noreply@google.com を受信許可してください。</p>

<p>参考URL: <a href="http://d.hatena.ne.jp/chipa34/2009/0121/1232506248">http://d.hatena.ne.jp/chipa34/2009/0121/1232506248</a></p>

<h2>GAE/P のチュートリアル</h2>

<p>公式で用意されているチュートリアルの紹介</p>

<p>URL: <a href="http://code.google.com/intl/ja/appengine/docs/python/gettingstarted/">http://code.google.com/intl/ja/appengine/docs/python/gettingstarted/</a></p>

<h2>Hello World アプリケーションの作成</h2>

<p>では、実際にアプリケーションを作成してみましょう。</p>

<p>お決まりですが、Hello, world! と出力するだけのアプリケーションを作成します。</p>

<pre><code>% mkdir helloworld
% cd helloworld
</code></pre>

<p>helloworld という名前のディレクトリを作成しました。アプリケーションに関するファイルは全てこのディレクトリに配置します。</p>

<h3>設定ファイルの作成</h3>

<p>Google App Engine では app.yaml というファイルにアプリケーションの設定を記述します。</p>

<pre><code>% cat app.yaml
application: helloworld  # アプリケーション名
version: 1               # アプリケーションのバージョン
runtime: python          
api_version: 1

handlers:                
- url: /.*               # URLが /.* に一致する場合は
  script: helloworld.py  # helloworld.py で処理する
</code></pre>

<p>このファイルを、helloworld ディレクトリ直下に配置します。</p>

<h3>アプリケーション本体の作成</h3>

<p>リクエストを実際に処理するスクリプトファイルを作成します。</p>

<pre><code>% cat helloworld.py
print 'Content-Type: text/plain'
print ''
print 'Hello, world!'
</code></pre>

<h3>アプリケーションの実行</h3>

<p>以上の二つのファイルを用意すればアプリケーションは完成です。
ファイル構成は以下のようになっています。</p>

<pre><code>% tree
.
|-- app.yaml
`-- helloworld.py
</code></pre>

<p>では、アプリケーションを実行してみましょう。デモを実行した場合と同様に dev_appserver.py を使用します。</p>

<pre><code>% dev_appserver.py ../helloworld
</code></pre>

<p>では、<a href="http://localhost:8080">http://localhost:8080</a> にアクセスしてみましょう。Hello, world! と出力されているはずです。</p>

<h2>webapp フレームワークを使ってみる</h2>

<p>このままだと物悲しいので、Web アプリケーションフレームワークを使ってみましょう。</p>

<p>Google App Engine は WSGI に対応しているため、様々な Web アプリケーションフレームワークを使うことができます。</p>

<ul>
<li>Django</li>
<li>web.py</li>
<li>cherrypy</li>
</ul>


<p>ここでは、Google が GAE のために用意した webapp というフレームワークを使ってみることにします。</p>

<p>補足: WSGI について</p>

<h2>GAE/P の便利機能の紹介</h2>

<h3>Task Queue</h3>

<p>キューにタスクをためておくと、サーバ側で非同期にタスクを実行してくれます。
タスクは特定の URL に対するリクエストとして定義されます。</p>

<pre><code>from google.appengine.api.labs import taskqueue

    class SomeHandler(webapp.RequestHandler): 
        def get(self):
            self.response.out.write('Hello, World!')

        def post(self):
            key = self.request.get('key')

            # Add the task to the default queue
            taskqueue.add(url='/worker', params={'key':key})
            self.redirect('/')


    class SomeWorker(webapp.RequestHandler):
        def post(self):
            ## some task...


def main():
    run_wsgi_app(webapp.WSGIApplication([
        ('/', SomeHandler),
        ('/worker', CounterWorker),
    ])

if __name__ == '__main__':
    main()
</code></pre>

<p>markovchains では、文章を解析してデータストアに保存する処理を Task Queue で行っています。同期的に処理する必要がない処理は積極的に Task Queue に投げるとよいと思われます。</p>

<p>URL: <a href="http://code.google.com/intl/ja/appengine/docs/python/taskqueue/overview.html">http://code.google.com/intl/ja/appengine/docs/python/taskqueue/overview.html</a></p>

<h3>Cron</h3>

<p>指定した時間、または一定の間隔で実行されるタスクのスケジュールを設定できます。タスクは特定の URL に対するリクエストとして定義されます。</p>

<p>URL: <a href="http://code.google.com/intl/ja/appengine/docs/python/config/cron.html">http://code.google.com/intl/ja/appengine/docs/python/config/cron.html</a></p>

<p>markovchains では、Cron を利用して文章を定期的に生成しています。これによって文章生成の負荷を平準化しています。</p>

<h3>Memcache</h3>

<p>GAE/P では memcached とよく似た Memcache という機能を提供しています。
Memcache は Key とそれに対応する Value を保存することができます。</p>

<pre><code>def get_data():
    data = memcache.get("key")
    if data is not None:
        return data
    else:
        data = self.query_for_data()
        memcache.add("key", data, 60)
        return data
</code></pre>

<p>Memcache の特徴として、</p>

<ul>
<li>高速に動作</li>
<li>容量が少ない</li>
<li>サーバの状態によっては勝手に破棄されることもある</li>
</ul>


<p>などがあります。あくまでキャッシュとして利用すべきで、実データは
DataStore に持たせておいた方がいいでしょう。</p>

<p>markovchains では生成しておいた文章の保管場所として等、様々な箇所で使用しています。</p>

<p>URL: <a href="http://code.google.com/intl/ja/appengine/docs/python/memcache/usingmemcache.html">http://code.google.com/intl/ja/appengine/docs/python/memcache/usingmemcache.html</a></p>

<h2>DataStore について</h2>

<p>DataStore を使う上でひっかかった箇所をまとめました。</p>

<h3>正規化は極力避けましょう</h3>

<p>DataStore は RDB ではありません。JOIN は使えません。正規化はやめましょう。</p>

<pre><code># ダメな例
class Word(db.Model):
    name = db.StringProperty()

class Chain(db.Model):
    preword = db.ReferenceProperty(Word)
    postword = db.ReferenceProperty(Word)
    isstart = db.BooleanProperty()

# よい例
class Chain(db.Model):
    preword = db.StringProperty(Word)
    postword = db.StringProperty(Word)
    isstart = db.BooleanProperty()
</code></pre>

<h3>Read / Write を減らす工夫をしましょう</h3>

<p>DataStore の Read は決して速くありません。Write はさらに遅いです。
極力一回のレスポンスで実行する get/put は減らす努力をしましょう。</p>

<p>put に関しては、本当に今すぐ更新しなければならないデータなのか考慮しましょう。
そうでない場合、Task Queue を使ってレスポンス内で処理しないようにしましょう。</p>

<p>get に関しては、</p>

<ul>
<li>正規化を避けて一つの画面で必要なデータは一つのモデルにまとめる</li>
<li>Memcache を活用する</li>
</ul>


<p>などを考慮にいれましょう。</p>

<p>ある条件で複数のデータをまとめて取得するような場合は、それらをあらかじめ取得しておいて（Cron を使うなどして）、Memcache に保存しておくという方法もよいでしょう。</p>

<pre><code># 複数のデータを取得
chains = Chain.gql("WHERE isstart = True")

# Memcache に突っ込む
memcache.add("isstart", chains)

# 必要なときに取り出す
chains = memcache.get("isstart")
</code></pre>

<p>以下、下記URLが参考になります。</p>

<p>URL:<a href="http://satoshi.blogs.com/life/2010/02/app_engine.html">http://satoshi.blogs.com/life/2010/02/app_engine.html</a></p>


<!-- Auto generated end -->

        </article>

        <footer>
            <p>Copyright &#169; 2010 <a href="mailto:yono.05@gmail.com">yono</a> All rights reserved.</p>
            <p>Powerd by <a href="http://github.com/Tomohiro/cg" title="cg - A Ruby based ContentsGenerator">cg - A Ruby based contents generator</a></p>
        </footer>
    </body>
</html>
